
@{
    ViewBag.Title = "ProductDetail";
}

<fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
    <legend id="title">新增产品</legend>
</fieldset>
<form class="layui-form" action="" lay-filter="prodInfo">
    <div class="layui-form-item">
        <label class="layui-form-label">产品编号</label>
        <div class="layui-input-inline">
            <input type="text" name="ProductID" required lay-verify="required"
                   placeholder="请输入产品编号" autocomplete="off" class="layui-input">
        </div>
        <!--产品编号可用提示框-->
        <div class="layui-form-mid" id="idTipMsg"></div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">产品名称</label>
        <div class="layui-input-block">
            <input type="text" name="ProductName" required lay-verify="required"
                   placeholder="请输入产品名称" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">价格</label>
        <div class="layui-input-block">
            <input type="text" name="Price" required lay-verify="required"
                   placeholder="请输入产品价格" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <label class="layui-form-label">库存</label>
        <div class="layui-input-block">
            <input type="text" name="ProductStockNumber" required lay-verify="required"
                   placeholder="请输入产品库存" autocomplete="off" class="layui-input">
        </div>
    </div>
    <div class="layui-form-item">
        <div class="layui-input-block">
            <button class="layui-btn" lay-submit lay-filter="saveProd">保存</button>
        </div>
    </div>
</form>

@section Scripts{
    <script>
        // 定义全局变量
        var id = getQueryString('id');// 从url获取key对应的value值
        var isEdit = false;// 标识当前的操作业务，false为新增业务，true为更新业务

        layui.use(['form'], function () {
            init();

            layui.form.on('submit(saveProd)', function (data) {
                saveProduct(data.field); // data.field 对应表单模型数据
                return false;// 阻止默认事件
            });

            bindEvent();
        });

        function init() {
            if (id) {
                isEdit = true;
                $('input[name=ProductID]').attr('disabled', true);
                $('input[name=ProductID]').addClass('layui-disabled');
            }
            if (isEdit) {
                $('#title').html('更新产品信息');
                getProductById();
            }
        }

        function bindEvent() {
            $('input[name=ProductID]').on('blur', checkProductID);
        }

        function saveProduct(prod) {
            var actionName = isEdit ? "UpdateProduct" : "SaveProduct";

            var url = `/Product/${actionName}`;
            $.post(url, prod, function (resp) {
                var obj = getObj(resp);
                if (obj.Status) {
                    layui.layer.msg('保存成功！');
                } else {
                    layui.layer.msg(obj.Message);
                }
            });
        }

        function checkProductID() {
            var id = $('input[name=ProductID]').val();
            var url = `/Product/CheckProductById?id=${id}`;
            $.get(url, function (resp) {
                var obj = getObj(resp);
                if (obj.Status) {
                    $('#idTipMsg').html('该编号产品已存在，请更换产品编号！');
                    $('#idTipMsg').css('color', '#FF5722');
                } else {
                    $('#idTipMsg').html('该产品编号可用！');
                    $('#idTipMsg').css('color', '#5FB878');
                }
            });
        }

        function setModel2View(entity) {
            layui.form.val('prodInfo', entity);
        }

        function getProductById() {
            var url = '/Product/GetProductById';
            $.post(url, { id: id }, function (resp) {
                var obj = getObj(resp);
                // 将产品对象绑定到页面显示
                setModel2View(obj);
            });
        }

    </script>
}